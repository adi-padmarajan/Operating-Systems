# MTS - A Multi-Threaded Train Scheduling Simulator

## 1. Overview

This project implements a multi-threaded train scheduling simulator named `mts`.  
The program simulates trains approaching a single shared main track from East/West stations with different priorities, enforcing the scheduling, fairness, and safety constraints defined in the assignment specification.

Core goals:

- Model each train as a **POSIX thread**.  
- Use **mutexes** and **condition variables** to coordinate access to a **single-track shared resource**.  
- Correctly implement:
  - Priority rules (high vs low).
  - Direction rules (East vs West).
  - Tie-breaking rules.
  - Fairness / starvation-avoidance constraints.
- Write all simulation logs to `output.txt` in the required format.

---

## 2. Repository Contents

- `mts.c` — Main implementation of the multi-thread scheduling simulator.  
- `Makefile` — Builds the `mts` executable using `make`.  
- `input.txt` — Sample test input file (must follow the specified format).  
- `output.txt` — Auto-generated by `mts` after each run; contains the simulation log for the last execution.

---

## 3. How to Build

The project is intended to be compiled and tested on **`linux.csc.uvic.ca`** (or equivalent departmental Linux environment).

```bash
make
```
This will:
Compile mts.c with gcc and pthreads.
Produce an executable named:

```bash
./mts
```
---
## 4. How to Run

Usage:

```bash
./mts input.txt
```
Where:
input.txt is the path to the train definition file.

Behavior:
- All simulation output is written to output.txt.
- output.txt is overwritten on each run (only the latest run is kept).
- Diagnostic errors (e.g., bad input, file issues, pthread failures) are printed to stderr.

---
## 5. Input Format

Each non-empty line in input.txt describes one train:

```
<dir> <loading_time> <crossing_time>
```

Where:
<dir> is one of:
e — Eastbound, low priority
E — Eastbound, high priority
w — Westbound, low priority
W — Westbound, high priority
<loading_time>: integer in [1, 99] (in tenths of a second)
<crossing_time>: integer in [1, 99] (in tenths of a second)
Trains are assigned IDs sequentially from 0 in file order.
Invalid lines, invalid direction chars, or out-of-range times cause parsing to fail and are reported to stderr.

---
## 6. Output Format

The program logs three types of events for each train:

Ready to depart:

```
HH:MM:SS.T Train XX is ready to go East|West
```

On the main track:

```
HH:MM:SS.T Train XX is ON the main track going East|West
```

Off the main track (done):

```
HH:MM:SS.T Train XX is OFF the main track after going East|West
```

Where:
- HH:MM:SS.T — elapsed simulation time since the global start, tenths precision.
- Train IDs printed with width 2 (%2d).
- Direction text is exactly "East" or "West".

All output is written via a thread-safe logging function protected by a mutex to prevent interleaving.
Timestamps are computed using CLOCK_MONOTONIC.

---

## 7. Design & Implementation Summary

### 7.1 Thread Model

- One thread per train: simulates loading, becomes ready, enqueues itself, waits to be dispatched, then simulates crossing.
- One dispatcher thread: central scheduling controller.
- Wakes when trains become ready or track becomes free.
- Selects the next train according to assignment rules and signals that train.
- Main thread parses input, spawns threads, waits for all to finish, cleans up, and exits.

### 7.2 Data Structures

Each train (train_t) stores:
- id, dir, high_priority, loading_time, crossing_time
- ready_time_ns, pthread_t tid, pthread_cond_t cv, my_turn
  
Ready queues:
- east_high, east_low, west_high, west_low
- Sorted by ready_time_ns then train ID (tie-breaking).
- Managed with helper functions for insertion/removal.

### 7.3 Synchronization

Global synchronization objects:
- scheduling_mutex — protects queues, track state, counters, and flags.
- ready_cv — trains signal when ready; dispatcher waits.
- Per-train condition variable — dispatcher wakes exactly one train.
- output_mutex — prevents mixed output to the log file.

### 7.4 Scheduling Policy

- Mutual exclusion: only one train on the track at a time.
- Ready-only scheduling: trains enqueue after loading.
- Priority first: high > low.
- Tie-breaking: earliest ready time, then lowest ID.
-Direction preference:
 - First train → West if both directions ready.
 - After 2 in one direction → switch to the other if available.
 - No busy waiting: uses condition variables instead of spinning.



---

## 8. Error Handling & Edge Cases

Missing/invalid file: prints perror and exits.

Empty file: exits cleanly.

Invalid lines: error printed with line number.

Thread creation failure: cleans up and exits.

Output errors: logged through perror.

---

## 9. Testing

Steps:

```bash
make
```

Prepare input.txt with cases such as:
- Single train.
- Mixed directions/priorities.
- Simultaneous ready times.
- Long same-direction streaks.

Run:

```bash
./mts input.txt
cat output.txt
```

Verify:
- Correct message format.
- Only one train on track at any time.
- High-priority precedence.
- Correct tie-breaking.
- Fairness after two in same direction.

---

Each tenth of a second = 0.1 real seconds.
Large valid inputs finish well under 1 minute.

---

## 10 Output (Actual Output for sample input.txt)

    00:00:00.3 Train  2 is ready to go East
    00:00:00.3 Train  2 is ON the main track going East
    00:00:00.6 Train  1 is ready to go West
    00:00:01.0 Train  0 is ready to go East
    00:00:01.3 Train  2 is OFF the main track after going East
    00:00:01.3 Train  1 is ON the main track going West
    00:00:02.0 Train  1 is OFF the main track after going West
    00:00:02.0 Train  0 is ON the main track going East
    00:00:02.6 Train  0 is OFF the main track after going East
---
    
